<?php

namespace JBF\Controller;
use Think\Controller;

class JFController extends Controller {

    public function index(){

        //print_r($_POST);
        //2017-02-02
        $saledate = $_POST['saledate'];
        $saleshop = $_POST['saleshop'];

        $???? = "XS170315%";
        //$???? = "XS".date('ymd',time())."%";
        $??? = '';

        $tSql ="SELECT T.???????,T.????????,T.???????,T.???????,T.?????,T.??????,T.?????,T.????,T.????,T.????,G.???,G.??????,G.?????,G.???????,G.?????,G.???????,G.????,G.????,C.C0218 AS ?????, C.C0205 AS ???, C.C0217 AS ??????, C.C0214 AS ??????? FROM(SELECT D.SaleID AS ???????,D.Type AS ????????,D.C0185 AS ???????,D.C0302 AS ???????,D.C0306 AS ?????,D.C0318 AS ??????,D.C0317 AS ?????,D.C0303 AS ????,D.c0312 AS ????, D.c0313 AS ???? FROM ITSV.uZBSALE.dbo.v_jbf_xsd_detail AS D WHERE SaleID LIKE '{????}') AS T LEFT JOIN ????? AS G ON T.??????? = G.????? LEFT JOIN ITSV.uZBSALE.dbo.C02 AS C ON T.??????? = C.C0201 {???} ORDER BY T.???????";

        //WHERE C.C0205='OL??j???????'
        //WHERE C.C0205='OL??j?????'
        $tSql=str_replace('{???}', $???, $tSql);
        $tSql=str_replace('{????}', $????, $tSql);
        $result = querydb($tSql);
        //print_r($result);

        $lst = array();

        foreach($result as $temp)
        {
            $??????? = $temp['???????'];

            if(!array_key_exists($???????, $lst))
            {
                $lst[$???????] = array();

                $lst[$???????]["???????"] = $???????;

                $lst[$???????]["??????"]   = 0;
                $lst[$???????]["??950????"]  = 0;
                $lst[$???????]["??????"]   = 0;
                $lst[$???????]["????????"]   = 0;
                $lst[$???????]["????????"]   = 0;
                $lst[$???????]["?????"]   = 0;

                $lst[$???????]["??????"]   = 0;
                $lst[$???????]["??950????"]  = 0;
                $lst[$???????]["??????"]   = 0;
                $lst[$???????]["??750????"]  = 0;
                $lst[$???????]["????????"]   = 0;
                $lst[$???????]["?????????"] = 0;

                $lst[$???????]["???????"]   = 0;
                $lst[$???????]["???????"]   = 0;
                $lst[$???????]["??????"]   = 0;
                $lst[$???????]["????????"]   = 0;
                $lst[$???????]["???????"]   = 0;
                $lst[$???????]["????????"]   = 0;
                $lst[$???????]["????????"]   = 0;
                $lst[$???????]["????????"]   = 0;
                $lst[$???????]["???????"]   = 0;
                $lst[$???????]["????????"]   = 0;

                $lst[$???????]["????????"]    = 0;
                $lst[$???????]["?????????"]    = 0;
                $lst[$???????]["??????"]   = 0;

                $lst[$???????]["?????"]     = $temp['?????'];
                $lst[$???????]["??????"]   = $temp['??????'];
                $lst[$???????]["???????"]   = $temp['???????'];
                $lst[$???????]["???????"]   = 0;
                $lst[$???????]["???"]       = $temp['???'];
                $lst[$???????]["??????"]   = 0;
            }

            $??????? = $temp['???????'];
            $???? = $temp['????'];
            $???? = $temp['????'];
            $???? = $temp['????'];
            $???? = $temp['????'];

            $???????? = $temp['????????'];
            $??????? = $temp['???????'];
            $????   = $temp['????'];
            $?????? = $temp['??????'];

            //???????????
            if($???????? == "????" and $????>0)
            {
                if($??????? == "SGL" and strstr($???????,"???"))
                {
                    $lst[$???????]["??????"] += $????;
                }
                elseif ($??????? == "SGL" and strstr($???????,"??950"))
                {
                    $lst[$???????]["??950????"] += $????;
                }
                elseif ($??????? == "SGL" and strstr($???????,"??"))
                {
                    $lst[$???????]["??????"] += $????;
                }
                elseif ($??????? == "SAG" and  $???? == "????")
                {
                    $lst[$???????]["????????"] += $????;
                }
                else
                {
                    $lst[$???????]["????????"] += $????;
                }
            }

            //???????????
            if($???????? == "????" and $????>0)
            {
                if($??????? == "SGL" and strstr($???????,"???"))
                {
                    $lst[$???????]["??????"] -= $????;
                }
                elseif ($??????? == "SGL" and strstr($???????,"??950"))
                {
                    $lst[$???????]["??950????"] -= $????;
                }
                elseif ($??????? == "SGL" and strstr($???????,"??"))
                {
                    $lst[$???????]["??????"] -= $????;
                }
                elseif ($??????? == "SAG" and  $???? == "????")
                {
                    $lst[$???????]["????????"] -= $????;
                }
                else
                {
                    $lst[$???????]["????????"] -= $????;
                }
            }

            //????????????
            if($???????? == "???")
            {
                $lst[$???????]["?????"] += $????;
            }

            //?????????????
            if($???????? == "????")
            {
                if (strstr($???????,"???"))
                {
                    $lst[$???????]["??????"] += $????;
                    $lst[$???????]["????????"]  += $????;
                }
                elseif (strstr($???????,"??950"))
                {
                    $lst[$???????]["??950????"] += $????;
                    $lst[$???????]["?????????"]  += $????;
                }
                elseif (strstr($???????,"??"))
                {
                    $lst[$???????]["??????"] += $????;
                    $lst[$???????]["?????????"]  += $????;
                }
                elseif (strstr($???????,"??750"))
                {
                    $lst[$???????]["??750????"] += $????;
                }
                elseif (strstr($???????,"????"))
                {
                    $lst[$???????]["????????"] += $????;
                }
                else
                {
                    $lst[$???????]["?????????"] += $????;
                }

                $lst[$???????]["??????"]  += $????;
            }

            //??????????
            if($???????? == "????" or $???????? == "????")
            {
                if ($???? == "???")
                {
                    $lst[$???????]["???????"]   += $????;
                }
                elseif ($???? == "3D???")
                {
                    $lst[$???????]["???????"]   += $????;
                }
                elseif ($??????? == "SGL" and $???? == "??????")
                {
                    $lst[$???????]["???????"]   += ($???? - $??????);

                    $lst[$???????]["??????"]   += $??????;
                }
                elseif ($??????? == "SGN" and $???? == "??????")
                {
                    $lst[$???????]["??????"]   += $????;
                }
                elseif ($???? == "????")
                {
                    $lst[$???????]["????????"]   += $????;
                }
                elseif ($???? == "???")
                {
                    $lst[$???????]["???????"]   += $????;
                }
                elseif ($??????? == "SAG" and $???? == "????")
                {
                    $lst[$???????]["????????"]   += $????;
                }
                elseif ($??????? == "YSL" and $???? == "????")
                {
                    $lst[$???????]["????????"]   += $????;
                }
                elseif ($???? == "????")
                {
                    $lst[$???????]["????????"]   += $????;
                }
                elseif ($???? == "???")
                {
                    $lst[$???????]["???????"]   += $????;
                }
                else
                {
                    $lst[$???????]["????????"]   += $????;
                }
            }

            $lst[$???????]["??????"] += $????;

            if($lst[$???????]["???????"]<> 0 and $lst[$???????]["????????"]<> 0)
            {
                $??????? = $lst[$???????]["???????"] + $lst[$???????]["????????"];
                if($??????? >0)
                {
                    $lst[$???????]["???????"] = $???????;
                    $lst[$???????]["??????"] -= $lst[$???????]["????????"];
                    $lst[$???????]["????????"] = 0;
                } else {
                    $lst[$???????]["????????"] = $???????;
                    $lst[$???????]["??????"] += $lst[$???????]["???????"];
                    $lst[$???????]["???????"] = 0;
                }
            }

            if($lst[$???????]["????????"]<> 0 and $lst[$???????]["?????????"]<> 0)
            {
                $???????? = $lst[$???????]["????????"] + $lst[$???????]["?????????"];
                if($???????? >0)
                {
                    $lst[$???????]["????????"] = $????????;
                    $lst[$???????]["??????"] -= $lst[$???????]["?????????"];
                    $lst[$???????]["?????????"] = 0;
                } else {
                    $lst[$???????]["?????????"] = $????????;
                    $lst[$???????]["??????"] += $lst[$???????]["????????"];
                    $lst[$???????]["????????"] = 0;
                }
            }

            //??????? ??????? 10???1?? \ ??????? 1???1??
            $????1?????? = $lst[$???????]["???????"] + $lst[$???????]["????????"];
            $????2?????? = $lst[$???????]["???????"] + $lst[$???????]["??????"] + $lst[$???????]["???????"] + $lst[$???????]["????????"] + $lst[$???????]["????????"] + $lst[$???????]["????????"]+ $lst[$???????]["???????"] + $lst[$???????]["????????"];

            $lst[$???????]["???????"] = $????1?????? *  0.1 + $????2?????? * 1;
        }

        $this->assign('lst',$lst);
        $this->show();
    }
}